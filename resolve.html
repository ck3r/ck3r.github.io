<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ckr resolver</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: monospace;
    background: #0b0b0b;
    color: #00ff9c;
    padding: 2rem;
  }
  .box {
    border: 1px solid #00ff9c;
    padding: 1rem;
    margin-top: 1rem;
  }
  .error { color: #ff5555; }
  .muted { color: #888; }
</style>
</head>
<body>

<h1>ckr:// resolver</h1>

<div id="output" class="box"></div>

<script>
(() => {
  const out = document.getElementById("output");
  const params = new URLSearchParams(location.search);
  const raw = params.get("uri");

  if (!raw) {
    out.innerHTML = `<span class="error">No URI provided.</span>`;
    return;
  }

  const decoded = decodeURIComponent(raw);

  if (!decoded.startsWith("web+ckr:")) {
    out.innerHTML = `<span class="error">Invalid scheme.</span>`;
    return;
  }

  // Strip scheme
  const payload = decoded.slice("web+ckr:".length);

  // Split payload
  const [head, query] = payload.split("?");
  const [command, mode] = head.split("@");

  // Load state
  const currentStage = localStorage.getItem("ckr_stage") || "none";

  // Debug output (intentional)
  out.innerHTML = `
    <div class="muted">raw</div>${decoded}<br><br>

    <div class="muted">command</div>${command || "(none)"}<br>
    <div class="muted">mode</div>${mode || "(default)"}<br>
    <div class="muted">query</div>${query || "(none)"}<br><br>

    <div class="muted">stored stage</div>${currentStage}<br><br>
  `;

  // --- Routing / stages ---

  const KONAMI =
  "‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è‚¨ÖÔ∏è‚û°Ô∏èüÖ±Ô∏èüÖ∞Ô∏è";

if (payload === KONAMI) {
  localStorage.setItem("ckr_stage", "konami");
  out.innerHTML += `
    <p>‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA</p>
    <p><strong>KONAMI CODE ACCEPTED</strong></p>
    <p>Proceed: <code>web+ckr:flag@secret</code></p>
  `;
  return;
}

  if (command === "init") {
    localStorage.setItem("ckr_stage", "init");
    out.innerHTML += `<p>Stage 0 initialized.</p>
      <p>Proceed: <code>web+ckr:auth@ctf</code></p>`;
    return;
  }

  if (command === "auth" && mode === "ctf") {
    if (currentStage !== "init") {
      out.innerHTML += `<p class="error">Initialization required.</p>`;
      return;
    }

    localStorage.setItem("ckr_stage", "auth");
    out.innerHTML += `<p>Authorization vector accepted.</p>
      <p>Proceed: <code>web+ckr:flag@stage1</code></p>`;
    return;
  }

  if (command === "flag") {
    if (currentStage !== "auth") {
      out.innerHTML += `<p class="error">Unauthorized flag access.</p>`;
      return;
    }

    localStorage.setItem("ckr_stage", "flag");
    out.innerHTML += `<p>Flag channel opened.</p>
      <p><strong>FLAG{uri_authority_is_a_lie}</strong></p>`;
    return;
  }

  out.innerHTML += `<p class="error">Unknown command.</p>`;
})();
</script>

</body>
</html>
